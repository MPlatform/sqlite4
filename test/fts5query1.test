# 2012 December 17
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
#
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix fts5query1

do_execsql_test 1.0 {
  CREATE TABLE t1(a PRIMARY KEY, b, c);
  CREATE INDEX i1 ON t1 USING fts5();
}

foreach {tn stmt} {
  1 "INSERT INTO t1 VALUES(1, 'a b c', 'd e f')"
  2 "INSERT INTO t1 VALUES(2, 'b c e', 'A A a')"
  3 "INSERT INTO t1 VALUES(3, 'd A A', 'e c a')"
  4 "DELETE FROM t1 WHERE a=1"
  5 "DELETE FROM t1"
  6 "INSERT INTO t1 VALUES(1, 'May you do', 'good and not evil')"
  7 "INSERT INTO t1 VALUES(2, 'May you find', 'forgiveness for yourself')"
  8 "UPDATE t1 SET b = 'and forgive others' WHERE a = 2"
  9 "UPDATE t1 SET a = 4, c = 'a b c d' WHERE a = 2"
} {
  do_execsql_test 1.$tn.1 $stmt
  do_execsql_test 1.$tn.2 {PRAGMA fts_check(i1)} ok
}

do_execsql_test 2.0 {
  DROP TABLE t1;
  CREATE TABLE t1(x PRIMARY KEY, y);
  CREATE INDEX i1 ON t1 USING fts5();

  INSERT INTO t1 VALUES(1, 'o n e');
  INSERT INTO t1 VALUES(2, 't w o');
  INSERT INTO t1 VALUES(3, 't h r e e');
  INSERT INTO t1 VALUES(4, 'f o u r');
}

foreach {tn stmt res} {
  1 {SELECT x FROM t1 WHERE t1 MATCH 't'}   {2 3}
  2 {SELECT x FROM t1 WHERE t1 MATCH 'abc'} {}
  3 {SELECT x FROM t1 WHERE t1 MATCH 't+h'} {3}
  4 {SELECT x FROM t1 WHERE t1 MATCH 't+o'} {}
} {
  do_execsql_test 2.$tn $stmt $res
}

do_execsql_test 3.0 {
  DROP TABLE t1;
  CREATE TABLE t1(x PRIMARY KEY, y);
  CREATE INDEX i1 ON t1 USING fts5();

  INSERT INTO t1 VALUES(1, 'a b c d e f g h i j k l m n o p q r s t u');
  INSERT INTO t1 VALUES(2, 'a e i o u b c d f g h j k l m n p q r s t');
  INSERT INTO t1 VALUES(3, 'b c d f g h j k l m n p q r s t v w x y z');
  INSERT INTO t1 VALUES(4, 'a e i o u');
}

foreach {tn stmt res} {
  1  {SELECT x FROM t1 WHERE t1 MATCH 'a NEAR/5 i'}       {2 4}
  2  {SELECT x FROM t1 WHERE t1 MATCH 'a NEAR/3 b'}       {1}
  3  {SELECT x FROM t1 WHERE t1 MATCH 'a NEAR/2 d'}       {1}
  4  {SELECT x FROM t1 WHERE t1 MATCH 'a NEAR/2 e'}       {2 4}
  5  {SELECT x FROM t1 WHERE t1 MATCH 'a NEAR/3 e'}       {1 2 4}
  6  {SELECT x FROM t1 WHERE t1 MATCH 'b+c NEAR/2 g+h'}   {2 3}
  7  {SELECT x FROM t1 WHERE t1 MATCH 'b+c NEAR/3 g+h'}   {1 2 3}
  8  {SELECT x FROM t1 WHERE t1 MATCH 'b+c NEAR/2 g+h+j'} {2 3}
  9  {SELECT x FROM t1 WHERE t1 MATCH 'b+c+d NEAR/1 g+h'} {2 3}
  10 {SELECT x FROM t1 WHERE t1 MATCH 'a AND d'}          {1 2}
  11 {SELECT x FROM t1 WHERE t1 MATCH 'a OR d'}           {1 2 3 4}
  12 {SELECT x FROM t1 WHERE t1 MATCH 'a NOT d'}          {4}
} {
  do_execsql_test 3.$tn $stmt $res
}

do_execsql_test 4.0 {
  CREATE TABLE t2(docid PRIMARY KEY, a, b, c);
  CREATE INDEX i2 ON t2 USING fts5();
  INSERT INTO t2 VALUES(136895, 'qkfl my qkfl krag gw', NULL, NULL);
}

do_execsql_test 4.1 {
  SELECT docid FROM t2 WHERE t2 MATCH 'qkfl NEAR/2 gw';
} {136895}

do_execsql_test 6.0 {
  CREATE TABLE t3(docid PRIMARY KEY, a, b, c);
  CREATE INDEX i3 ON t3 USING fts5();
  INSERT INTO t3 VALUES(123, 'fix the hash table', NULL, NULL);
}
do_execsql_test 5.1 {
  SELECT docid FROM t3 WHERE t3 MATCH 'h*';
} {123}

do_execsql_test 6.0 {

BEGIN TRANSACTION;
CREATE TABLE t4(docid PRIMARY KEY, a, b, c);
CREATE INDEX i4 ON t4 USING fts5();

INSERT INTO "t4" VALUES(34,'ndmv jk qhiv cnz kyev blu qs nxhf etm uen','uh hu as wcvo hw whgu wd zm saus jvg bmbx kyev bnyk wmbz yf uh rb yf ju blu jkb jk qkfl jk gimj uh brsu ptic ka ztc vniq uprt kyev rxcf blu bnyk mu hgjo rxcf rnxr vcy vllx mve nxhf kb iddj qpnv fal iddj ju zidh mu pvjr cu my blu ztc vllx ono ndmv ib mu qpnv ldfi jvg jvg ztc uprt qrwj ptic saus fltt uen cnz ju qrwj gfap jk krag bwsr kb csjq kn krag ono uv krag da cu bil wd sk','ib qrwj iddj cku qdye uv pnz hu wte kyev ka jvg hu mu las bwsr mu uv da szem vllx bwsr wfar blu uv ztc qpnv wwne osok qpnv');
INSERT INTO "t4" VALUES(50,'ldfi zlc cku cnz sk juhw nxhf iddj las hu qhiv bmbx nq kn uprt las jk pvjr urvy qs bwsr uyn pmh ssc fltt bmbx ldfi rnxr cnz yf rnxr ndmv wmbz fal pmh uyn sk uh szem uv ssc bnyk yle jvg zm hgjo uh blu jvg rxcf whgu ztc kyev xdza cku kyev juhw nq ldfi las uprt wwne uprt qrwj vniq fal szem fteo cnz bwsr jrx jk jpa uv pmh nq qdye gfap ldfi uen sk wgwd zidh cu gfap','wd ndmv saus pnz hgjo gimj ztc jrx krag jrx gimj qhiv saj hgjo jrx xdza gvp cku kn szem my saus bnyk saj pmh gw bnyk saj as zimg ssc kh pvjr fal etm cu jvg krag hbtv kb szem qdye uv bil aayx wmbz xdza zm ib ldfi brsu zm rnxr csjq ldfi kb vllx zidh','gw fteo ka cu ib hu fteo juhw yf pnz blu jk ka bnyk bwsr da pnz pvjr yf pmh csjq my ztc zm hbtv qrwj cnz hu mu za ldfi qpnv saj');
COMMIT;
}

breakpoint
do_execsql_test 6.1 {
  SELECT docid FROM t4 WHERE t4 MATCH 'm*' 
} {34 50}

finish_test

